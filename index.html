<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profesor - Sistema de Asistencia QR</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <!-- QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <!-- SheetJS COMPLETO con soporte de estilos -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <style>
    * { font-family: 'Poppins', sans-serif; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
    .animate-slide-in { animation: slideIn 0.3s ease-out; }
    .hover-lift { transition: all 0.3s ease; }
    .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; }
    .btn-primary:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
    .qr-container { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
    .qr-salida { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
    @media (max-width: 768px){ h1 { font-size: 1.75rem !important; } }
  </style>
</head>

<body class="gradient-bg min-h-screen py-6">
  <div class="container mx-auto px-4 sm:px-6 max-w-7xl">

    <!-- LOGIN -->
    <div id="loginCard" class="max-w-md mx-auto card-glass rounded-3xl shadow-2xl p-8 animate-fade-in">
      <h2 class="text-2xl font-extrabold text-center bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent mb-6">
        Acceso de Profesor
      </h2>
      <label class="block font-semibold mb-2" for="email">Correo</label>
      <input id="email" type="email" class="w-full border rounded-xl px-4 py-3 mb-4" placeholder="tu@colegio.edu" autocomplete="username"/>

      <label class="block font-semibold mb-2" for="pass">Contrase√±a</label>
      <input id="pass" type="password" class="w-full border rounded-xl px-4 py-3 mb-6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>

      <button id="btnLogin" class="w-full btn-primary text-white py-3.5 rounded-xl font-bold">
        Entrar
      </button>

      <p class="text-gray-500 text-sm mt-4">
        * Aseg√∫rate de tener <code>admins/{tuUID}=true</code> en Realtime Database.
      </p>
    </div>

    <!-- PANEL PROFESOR -->
    <div id="panel" class="hidden">
      <!-- Header -->
      <div class="card-glass rounded-3xl shadow-2xl p-6 mb-6 animate-fade-in">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
          <div class="text-center sm:text-left">
            <div class="flex items-center justify-center sm:justify-start gap-3 mb-2">
              <div class="bg-gradient-to-br from-purple-500 to-indigo-600 p-3 rounded-2xl shadow-lg">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
              </div>
              <h1 class="text-3xl sm:text-4xl font-extrabold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">
                Panel del Profesor
              </h1>
            </div>
            <p class="text-gray-600 font-medium">Gestiona tus clases y alumnos</p>
            <p id="whoami" class="text-gray-500 text-sm mt-1"></p>
          </div>

          <div class="flex gap-3 w-full sm:w-auto">
            <button id="btnNuevaAula" class="btn-primary text-white px-5 py-3 rounded-2xl font-bold flex items-center gap-2 shadow-xl w-full sm:w-auto justify-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              Nueva Aula
            </button>
            <button id="btnSalir" class="bg-white text-indigo-600 px-5 py-3 rounded-2xl font-bold border shadow w-full sm:w-auto">
              Salir
            </button>
          </div>
        </div>
      </div>

      <!-- Aulas Grid -->
      <div id="aulasContainer" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6"></div>
    </div>
  </div>

  <!-- Modal para gestionar alumnos -->
  <div id="modalAlumnos" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-height-[90vh] overflow-hidden animate-slide-in">
      <div class="gradient-bg text-white p-6 sm:p-8 flex justify-between items-center">
        <h3 class="text-xl sm:text-2xl font-bold" id="modalTitle">Gestionar Alumnos</h3>
        <button id="btnCerrarModal" class="hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="p-4 sm:p-8 overflow-y-auto max-h-[calc(90vh-150px)]">
        <!-- Agregar alumno manualmente -->
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-2xl p-6 mb-6 border-2 border-indigo-200">
          <h4 class="font-bold text-lg mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
            </svg>
            Agregar Alumno
          </h4>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-semibold mb-2">N√∫mero de Control (8 d√≠gitos)</label>
              <input type="text" id="nuevoNumControl" maxlength="8" placeholder="12345678" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">Nombre Completo</label>
              <input type="text" id="nuevoNombre" placeholder="Juan P√©rez Garc√≠a" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none">
            </div>
          </div>
          <button id="btnAgregarAlumno" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl font-bold hover:shadow-xl transition-all">
            Agregar Alumno
          </button>
        </div>

        <!-- Buscar -->
        <div class="mb-6">
          <div class="relative">
            <svg class="absolute left-4 top-4 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" id="buscarAlumno" placeholder="Buscar alumno..." class="w-full pl-12 pr-4 py-3 sm:py-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none text-base sm:text-lg">
          </div>
        </div>

        <!-- Lista de alumnos -->
        <div class="bg-gray-50 rounded-2xl p-4 sm:p-6">
          <h4 class="font-bold text-lg sm:text-xl text-gray-800 mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            Alumnos Registrados (<span id="contadorAlumnos">0</span>)
          </h4>
          <div id="listaAlumnos" class="space-y-3 max-h-80 overflow-y-auto"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed top-4 right-4 z-50 px-6 py-4 rounded-2xl shadow-2xl text-white font-bold max-w-sm"></div>

  <script>
    /* ==== Firebase ==== */
    const firebaseConfig = {
      apiKey: "AIzaSyCnjFF4srF6nlhrGO0EteYGe6C7W36wSPc",
      authDomain: "macroqr-9cee8.firebaseapp.com",
      databaseURL: "https://macroqr-9cee8-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "macroqr-9cee8",
      storageBucket: "macroqr-9cee8.firebasestorage.app",
      messagingSenderId: "751611795247",
      appId: "1:751611795247:web:c28b92b31ded4fdd5cb3da",
      measurementId: "G-WR5H7L26DH"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    /* ==== Config local ==== */
    const URL_ALUMNO = 'https://yaelito12.github.io/MacroQRAsistencia/alumno.html';

    /* ==== Estado ==== */
    let aulas = {};
    let asistencias = {};
    let alumnosRegistrados = {};
    let aulaSeleccionada = null;
    let currentUID = null;

    /* ==== Utils ==== */
    const $ = (id)=>document.getElementById(id);

    function mostrarMensaje(texto, tipo) {
      const toast = $('toast');
      toast.innerHTML = `
        <div class="flex items-center gap-3">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            ${tipo === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' :
              tipo === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' :
                                 '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}
          </svg>
          <span>${texto}</span>
        </div>`;
      toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-2xl shadow-2xl text-white font-bold max-w-sm animate-fade-in ${
        tipo === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600' :
        tipo === 'error'   ? 'bg-gradient-to-r from-red-500 to-pink-600' :
                             'bg-gradient-to-r from-blue-500 to-indigo-600'
      }`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 4000);
    }

    function buildSessionId(aulaId){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${aulaId}-${yyyy}${mm}${dd}`;
    }
    
    function urlDeSesion(aulaId, tipo = 'entrada'){
      const sid = buildSessionId(aulaId);
      return `${URL_ALUMNO}?aula=${encodeURIComponent(aulaId)}&sid=${encodeURIComponent(sid)}&tipo=${tipo}`;
    }
    
    function renderQR(div, dataUrl){
      div.innerHTML = '';
      new QRCode(div, { text: dataUrl, width: 300, height: 300, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
    }
    
    function validarNumeroControl(num) { return /^\d{8}$/.test(num); }
    function validarNombre(nombre) { return /^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(nombre); }

    async function checkIsAdmin(uid){
      const snap = await database.ref('admins/'+uid).get();
      return snap.exists() && snap.val() === true;
    }

    async function verificarNombreAulaUnico(nombre) {
      const nombreNormalizado = nombre.trim().toLowerCase();
      const aulasArray = Object.values(aulas || {});
      
      return !aulasArray.some(aula => 
        aula.nombre.trim().toLowerCase() === nombreNormalizado
      );
    }

    /* ==== Auth ==== */
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        $('loginCard').classList.remove('hidden');
        $('panel').classList.add('hidden');
        return;
      }
      currentUID = user.uid;
      $('whoami').textContent = `UID: ${currentUID}`;
      const isAdmin = await checkIsAdmin(currentUID);
      if (!isAdmin) {
        $('loginCard').classList.remove('hidden');
        $('panel').classList.add('hidden');
        mostrarMensaje('Tu cuenta no tiene permisos de profesor. Pide que te agreguen en admins/{uid}.', 'error');
        return;
      }
      $('loginCard').classList.add('hidden');
      $('panel').classList.remove('hidden');
    });

    /* ==== Aulas ==== */
    async function crearAula() {
      if (!currentUID) {
        mostrarMensaje('Debes iniciar sesi√≥n primero', 'error');
        return;
      }

      const nombre = prompt('Nombre del aula (ej: Matem√°ticas 101):');
      
      if (!nombre || nombre.trim() === '') {
        mostrarMensaje('Nombre de aula inv√°lido', 'error');
        return;
      }

      const esUnico = await verificarNombreAulaUnico(nombre);
      if (!esUnico) {
        mostrarMensaje('Ya existe un aula con ese nombre. Por favor elige otro nombre.', 'error');
        return;
      }

      try {
        const refAula = database.ref('aulas').push();
        const aulaId = refAula.key;
        
        const payload = {
          id: aulaId,
          nombre: nombre.trim(),
          creadoPor: currentUID,
          creadoEn: Date.now()
        };

        await refAula.set(payload);
        mostrarMensaje('Aula creada exitosamente', 'success');
      } catch (error) {
        console.error('Error al crear aula:', error);
        mostrarMensaje('Error al crear el aula: ' + (error.message || error), 'error');
      }
    }

    /* ==== Alumnos (modal) ==== */
    function abrirModalAlumnos(aulaId) {
      aulaSeleccionada = aulaId;
      const aula = aulas[aulaId];
      $('modalTitle').textContent = aula?.nombre || aulaId;
      $('modalAlumnos').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      renderizarAlumnos();
    }
    function cerrarModal() {
      $('modalAlumnos').classList.add('hidden');
      document.body.style.overflow = 'auto';
      $('buscarAlumno').value = '';
      aulaSeleccionada = null;
    }

    async function agregarAlumnoManual() {
      if (!aulaSeleccionada) return mostrarMensaje('Selecciona un aula', 'error');

      const numControl = $('nuevoNumControl').value.trim();
      const nombre = $('nuevoNombre').value.trim();

      if (!numControl || !nombre) return mostrarMensaje('Completa todos los campos', 'error');
      if (!validarNumeroControl(numControl)) return mostrarMensaje('El n√∫mero de control debe tener exactamente 8 d√≠gitos', 'error');
      if (!validarNombre(nombre)) return mostrarMensaje('El nombre solo debe contener letras y espacios', 'error');

      const refAlumno = database.ref('alumnos/' + aulaSeleccionada + '/' + numControl);
      const snap = await refAlumno.get();
      if (snap.exists()) return mostrarMensaje('Este alumno ya est√° registrado', 'error');

      await refAlumno.set({ numeroControl: numControl, nombre });
      $('nuevoNumControl').value = '';
      $('nuevoNombre').value = '';
      mostrarMensaje('Alumno agregado exitosamente', 'success');
    }

    function eliminarAlumno(numeroControl) {
      if (!confirm('¬øEliminar este alumno?')) return;
      database.ref('alumnos/' + aulaSeleccionada + '/' + numeroControl).remove();
      mostrarMensaje('Alumno eliminado', 'success');
    }

    function renderizarAlumnos() {
      const buscar = $('buscarAlumno').value.toLowerCase();
      const alumnosObj = (alumnosRegistrados && alumnosRegistrados[aulaSeleccionada]) || {};
      const alumnosAula = Object.values(alumnosObj || {});

      const alumnosFiltrados = alumnosAula.filter(a =>
        (a.nombre||'').toLowerCase().includes(buscar) || (a.numeroControl||'').includes(buscar)
      );

      $('contadorAlumnos').textContent = alumnosFiltrados.length;
      const lista = $('listaAlumnos');
      if (alumnosFiltrados.length === 0) {
        lista.innerHTML = '<p class="text-center text-gray-500 py-8 text-lg">No hay alumnos registrados a√∫n</p>';
        return;
      }
      lista.innerHTML = alumnosFiltrados.map(alumno => `
        <div class="bg-white rounded-xl p-4 flex justify-between items-center shadow-md hover:shadow-lg transition-all border border-gray-100">
          <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg">
              ${(alumno.nombre||'?').charAt(0).toUpperCase()}
            </div>
            <div>
              <p class="font-bold text-gray-800 text-base">${alumno.nombre||'‚Äî'}</p>
              <p class="text-sm text-gray-600 font-medium">${alumno.numeroControl||'‚Äî'}</p>
            </div>
          </div>
          <button onclick="eliminarAlumno('${alumno.numeroControl||''}')" class="bg-red-500 text-white p-3 rounded-xl hover:bg-red-600 transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 01-1 1v3M4 7h16"></path>
            </svg>
          </button>
        </div>
      `).join('');
    }

    /* ==== Asistencias / Aulas UI ==== */
    function copiarURL(aulaId, tipo = 'entrada') {
      const urlCompleta = urlDeSesion(aulaId, tipo);
      navigator.clipboard.writeText(urlCompleta)
        .then(() => mostrarMensaje(`URL de ${tipo} copiada al portapapeles`, 'success'))
        .catch(()  => mostrarMensaje('No se pudo copiar la URL', 'error'));
    }

    function exportarExcel(aulaId) {
      const fechaKey = new Date().toLocaleDateString('es-MX').split('/').reverse().join('');
      const fechaLegible = new Date().toLocaleDateString('es-MX', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      const aula = aulas[aulaId];
      const registrosHoyObj = (asistencias[aulaId] && asistencias[aulaId][fechaKey]) || {};
      
      // Unificar entrada y salida por alumno
      let alumnosUnificados = {};
      Object.keys(registrosHoyObj).forEach(numeroControl => {
        const tiposRegistro = registrosHoyObj[numeroControl];
        
        if (!alumnosUnificados[numeroControl]) {
          alumnosUnificados[numeroControl] = {
            numeroControl: numeroControl,
            nombre: '',
            horaEntrada: '',
            horaSalida: ''
          };
        }
        
        if (tiposRegistro.entrada) {
          alumnosUnificados[numeroControl].nombre = tiposRegistro.entrada.nombre || 'Sin nombre';
          alumnosUnificados[numeroControl].horaEntrada = tiposRegistro.entrada.hora || '';
        }
        
        if (tiposRegistro.salida) {
          alumnosUnificados[numeroControl].nombre = tiposRegistro.salida.nombre || alumnosUnificados[numeroControl].nombre;
          alumnosUnificados[numeroControl].horaSalida = tiposRegistro.salida.hora || '';
        }
      });
      
      const registros = Object.values(alumnosUnificados);
      
      if (registros.length === 0) { 
        mostrarMensaje('No hay registros para exportar', 'error'); 
        return; 
      }

      // Crear el workbook
      const wb = XLSX.utils.book_new();
      
      // T√≠tulo y subt√≠tulo
      const titulo = [[`Reporte de Asistencia - ${aula?.nombre || 'Aula'}`]];
      const subtitulo = [[fechaLegible]];
      const espacio = [[]];
      
      // Encabezados
      const headers = [['N¬∞ Control', 'Nombre Completo', 'Hora Entrada', 'Hora Salida', 'Estado']];
      
      // Datos con estado calculado
      const datos = registros.map(r => {
        let estado = '';
        if (r.horaEntrada && r.horaSalida) {
          estado = 'Completo ‚úì';
        } else if (r.horaEntrada && !r.horaSalida) {
          estado = 'Sin salida ‚ö†';
        } else if (!r.horaEntrada && r.horaSalida) {
          estado = 'Solo salida ‚ö†';
        }
        
        return [
          r.numeroControl || '',
          r.nombre || 'Sin nombre',
          r.horaEntrada || '--:--',
          r.horaSalida || '--:--',
          estado
        ];
      });
      
      // Estad√≠sticas
      const totalAlumnos = registros.length;
      const conEntrada = registros.filter(r => r.horaEntrada).length;
      const conSalida = registros.filter(r => r.horaSalida).length;
      const completos = registros.filter(r => r.horaEntrada && r.horaSalida).length;
      
      const estadisticas = [
        [],
        ['RESUMEN DE ASISTENCIA'],
        ['Total de registros:', totalAlumnos],
        ['Con entrada:', conEntrada],
        ['Con salida:', conSalida],
        ['Registros completos:', completos]
      ];
      
      // Combinar datos
      const wsData = [...titulo, ...subtitulo, ...espacio, ...headers, ...datos, ...estadisticas];
      
      // Crear worksheet
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Anchos de columna
      ws['!cols'] = [
        { wch: 14 },
        { wch: 35 },
        { wch: 16 },
        { wch: 16 },
        { wch: 20 }
      ];
      
      // Combinar celdas
      ws['!merges'] = [
        { s: { r: 0, c: 0 }, e: { r: 0, c: 4 } },
        { s: { r: 1, c: 0 }, e: { r: 1, c: 4 } },
        { s: { r: 5 + datos.length, c: 0 }, e: { r: 5 + datos.length, c: 4 } }
      ];
      
      // APLICAR ESTILOS
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      // Funci√≥n para crear estilo de celda
      function crearEstilo(fill, font, border, alignment) {
        return {
          fill: fill || {},
          font: font || {},
          border: border || {},
          alignment: alignment || {}
        };
      }
      
      // Bordes
      const bordeGrueso = {
        top: { style: "medium", color: { rgb: "000000" } },
        bottom: { style: "medium", color: { rgb: "000000" } },
        left: { style: "medium", color: { rgb: "000000" } },
        right: { style: "medium", color: { rgb: "000000" } }
      };
      
      const bordeFino = {
        top: { style: "thin", color: { rgb: "D1D5DB" } },
        bottom: { style: "thin", color: { rgb: "D1D5DB" } },
        left: { style: "thin", color: { rgb: "D1D5DB" } },
        right: { style: "thin", color: { rgb: "D1D5DB" } }
      };
      
      // Estilizar T√çTULO (Fila 0)
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const address = XLSX.utils.encode_cell({ r: 0, c: C });
        if (!ws[address]) continue;
        ws[address].s = crearEstilo(
          { fgColor: { rgb: "4F46E5" } },
          { bold: true, sz: 18, color: { rgb: "FFFFFF" } },
          bordeGrueso,
          { horizontal: "center", vertical: "center" }
        );
      }
      
      // Estilizar SUBT√çTULO (Fila 1)
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const address = XLSX.utils.encode_cell({ r: 1, c: C });
        if (!ws[address]) continue;
        ws[address].s = crearEstilo(
          { fgColor: { rgb: "E5E7EB" } },
          { sz: 12, italic: true, color: { rgb: "4B5563" } },
          bordeFino,
          { horizontal: "center", vertical: "center" }
        );
      }
      
      // Estilizar ENCABEZADOS (Fila 3, √≠ndice 3)
      const coloresEncabezado = [
        "6366F1", // N¬∞ Control
        "8B5CF6", // Nombre
        "10B981", // Entrada
        "EF4444", // Salida
        "F59E0B"  // Estado
      ];
      
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const address = XLSX.utils.encode_cell({ r: 3, c: C });
        if (!ws[address]) continue;
        ws[address].s = crearEstilo(
          { fgColor: { rgb: coloresEncabezado[C] } },
          { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
          bordeGrueso,
          { horizontal: "center", vertical: "center" }
        );
      }
      
      // Estilizar DATOS (Filas 4 en adelante hasta antes de estad√≠sticas)
      const filaInicioDatos = 4;
      const filaFinDatos = 4 + datos.length - 1;
      
      for (let R = filaInicioDatos; R <= filaFinDatos; ++R) {
        const esFilaPar = (R - filaInicioDatos) % 2 === 0;
        
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const address = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[address]) continue;
          
          let fillColor = esFilaPar ? "F9FAFB" : "FFFFFF";
          let fontColor = "1F2937";
          let fontBold = false;
          const idx = R - filaInicioDatos;
          
          // Columna Hora Entrada (C=2)
          if (C === 2 && datos[idx] && datos[idx][2] !== '--:--') {
            fillColor = "D1FAE5";
            fontColor = "065F46";
            fontBold = true;
          }
          
          // Columna Hora Salida (C=3)
          if (C === 3 && datos[idx] && datos[idx][3] !== '--:--') {
            fillColor = "FEE2E2";
            fontColor = "991B1B";
            fontBold = true;
          }
          
          // Columna Estado (C=4)
          if (C === 4 && datos[idx]) {
            if (datos[idx][4].includes('Completo')) {
              fillColor = "D1FAE5";
              fontColor = "065F46";
              fontBold = true;
            } else if (datos[idx][4].includes('Sin salida') || datos[idx][4].includes('Solo salida')) {
              fillColor = "FEF3C7";
              fontColor = "92400E";
              fontBold = true;
            }
          }
          
          ws[address].s = crearEstilo(
            { fgColor: { rgb: fillColor } },
            { sz: 11, color: { rgb: fontColor }, bold: fontBold },
            bordeFino,
            { horizontal: C === 1 ? "left" : "center", vertical: "center" }
          );
        }
      }
      
      // Estilizar RESUMEN (despu√©s de una fila vac√≠a)
      const filaResumenInicio = filaFinDatos + 2;
      
      // T√≠tulo del resumen
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const address = XLSX.utils.encode_cell({ r: filaResumenInicio, c: C });
        if (!ws[address]) continue;
        ws[address].s = crearEstilo(
          { fgColor: { rgb: "059669" } },
          { bold: true, sz: 14, color: { rgb: "FFFFFF" } },
          bordeGrueso,
          { horizontal: "center", vertical: "center" }
        );
      }
      
      // Filas de estad√≠sticas
      for (let i = 1; i <= 4; i++) {
        const R = filaResumenInicio + i;
        
        // Columna A (etiqueta)
        const addressLabel = XLSX.utils.encode_cell({ r: R, c: 0 });
        if (ws[addressLabel]) {
          ws[addressLabel].s = crearEstilo(
            { fgColor: { rgb: "E5E7EB" } },
            { bold: true, sz: 11, color: { rgb: "374151" } },
            bordeFino,
            { horizontal: "left", vertical: "center" }
          );
        }
        
        // Columna B (valor)
        const addressValue = XLSX.utils.encode_cell({ r: R, c: 1 });
        if (ws[addressValue]) {
          ws[addressValue].s = crearEstilo(
            { fgColor: { rgb: "FFFFFF" } },
            { bold: true, sz: 11, color: { rgb: "1F2937" } },
            bordeFino,
            { horizontal: "center", vertical: "center" }
          );
        }
      }
      
      // Agregar worksheet al workbook
      XLSX.utils.book_append_sheet(wb, ws, "Asistencia");
      
      // Generar archivo
      const nombreArchivo = `Asistencia_${(aula?.nombre||'Aula').replace(/\s/g,'_')}_${fechaKey}.xlsx`;
      XLSX.writeFile(wb, nombreArchivo);
      
      mostrarMensaje('Excel descargado con formato profesional', 'success');
    }

    function renderizarAulas() {
      const container = $('aulasContainer');
      const aulasArray = Object.values(aulas || {});
      if (aulasArray.length === 0) {
        container.innerHTML = `
          <div class="col-span-full card-glass rounded-3xl shadow-2xl p-8 sm:p-12 text-center animate-fade-in">
            <div class="text-7xl sm:text-8xl mb-6">üìö</div>
            <p class="text-gray-700 text-xl sm:text-2xl font-bold mb-2">No hay aulas creadas</p>
            <p class="text-gray-500 text-base sm:text-lg">Crea tu primera aula para comenzar</p>
          </div>`;
        return;
      }

      const fechaKey = new Date().toLocaleDateString('es-MX').split('/').reverse().join('');

      container.innerHTML = aulasArray.map((aula, index) => {
        const alumnosAula = Object.values((alumnosRegistrados && alumnosRegistrados[aula.id]) || {});
        const registrosHoyObj = (asistencias[aula.id] && asistencias[aula.id][fechaKey]) || {};
        
        let alumnosUnificados = {};
        Object.keys(registrosHoyObj).forEach(numeroControl => {
          const tiposRegistro = registrosHoyObj[numeroControl];
          
          if (!alumnosUnificados[numeroControl]) {
            alumnosUnificados[numeroControl] = {
              numeroControl: numeroControl,
              nombre: '',
              horaEntrada: '',
              horaSalida: ''
            };
          }
          
          if (tiposRegistro.entrada) {
            alumnosUnificados[numeroControl].nombre = tiposRegistro.entrada.nombre || 'Sin nombre';
            alumnosUnificados[numeroControl].horaEntrada = tiposRegistro.entrada.hora || '';
          }
          
          if (tiposRegistro.salida) {
            alumnosUnificados[numeroControl].nombre = tiposRegistro.salida.nombre || alumnosUnificados[numeroControl].nombre;
            alumnosUnificados[numeroControl].horaSalida = tiposRegistro.salida.hora || '';
          }
        });

        const registrosUnificados = Object.values(alumnosUnificados);
        const ultimos = registrosUnificados.slice(-5).reverse();

        return `
          <div class="card-glass rounded-3xl shadow-xl p-4 sm:p-6 relative hover-lift animate-fade-in" style="animation-delay: ${index * 0.05}s">
            <button onclick="eliminarAula('${aula.id}')" class="absolute top-3 right-3 bg-red-500 text-white p-2 rounded-xl hover:bg-red-600 transition-all shadow-lg z-10">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 01-1 1v3M4 7h16"></path>
              </svg>
            </button>
            <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 pr-10">${aula.nombre}</h3>
            
            <!-- QR de Entrada -->
            <div class="qr-container rounded-2xl p-4 sm:p-6 mb-4 shadow-inner">
              <div class="flex items-center justify-center gap-2 mb-2">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                </svg>
                <p class="text-center text-sm font-bold text-green-700">QR de Entrada</p>
              </div>
              <div id="qr-entrada-${aula.id}" class="mx-auto mb-3 flex items-center justify-center"></div>
              <button onclick="copiarURL('${aula.id}', 'entrada')" class="w-full bg-green-600 text-white py-2 px-3 rounded-lg font-bold text-sm hover:bg-green-700 transition-all flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                Copiar URL Entrada
              </button>
            </div>

            <!-- QR de Salida -->
            <div class="qr-salida rounded-2xl p-4 sm:p-6 mb-4 shadow-inner">
              <div class="flex items-center justify-center gap-2 mb-2">
                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                <p class="text-center text-sm font-bold text-red-700">QR de Salida</p>
              </div>
              <div id="qr-salida-${aula.id}" class="mx-auto mb-3 flex items-center justify-center"></div>
              <button onclick="copiarURL('${aula.id}', 'salida')" class="w-full bg-red-600 text-white py-2 px-3 rounded-lg font-bold text-sm hover:bg-red-700 transition-all flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                Copiar URL Salida
              </button>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
              <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl p-3 sm:p-4 text-center text-white shadow-lg">
                <p class="text-xs sm:text-sm font-semibold mb-1 opacity-90">Alumnos</p>
                <p class="text-2xl sm:text-3xl font-bold">${alumnosAula.length}</p>
              </div>
              <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-3 sm:p-4 text-center text-white shadow-lg">
                <p class="text-xs sm:text-sm font-semibold mb-1 opacity-90">Registros Hoy</p>
                <p class="text-2xl sm:text-3xl font-bold">${registrosUnificados.length}</p>
              </div>
            </div>
            ${registrosUnificados.length > 0 ? `
              <div class="mb-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-3 sm:p-4 border border-green-200">
                <p class="font-bold text-gray-700 mb-2 text-sm sm:text-base flex items-center gap-2">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  √öltimos registros:
                </p>
                <div class="space-y-2 max-h-32 overflow-y-auto">
                  ${ultimos.map(reg => `
                    <div class="bg-white rounded-lg p-2 shadow-sm">
                      <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-gray-800 text-xs sm:text-sm">${reg.nombre || 'Sin nombre'}</span>
                      </div>
                      <div class="flex gap-3 text-xs">
                        <span class="flex items-center gap-1 ${reg.horaEntrada ? 'text-green-600' : 'text-gray-400'}">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                          </svg>
                          ${reg.horaEntrada || '--:--'}
                        </span>
                        <span class="flex items-center gap-1 ${reg.horaSalida ? 'text-red-600' : 'text-gray-400'}">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                          </svg>
                          ${reg.horaSalida || '--:--'}
                        </span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            <div class="grid grid-cols-2 gap-3">
              <button onclick="abrirModalAlumnos('${aula.id}')" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-xl hover:shadow-xl font-bold text-sm sm:text-base transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                Alumnos
              </button>
              <button onclick="exportarExcel('${aula.id}')" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-xl hover:shadow-xl font-bold text-sm sm:text-base transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Excel
              </button>
            </div>
          </div>
        `;
      }).join('');

      setTimeout(() => {
        aulasArray.forEach(aula => {
          const divEntrada = document.getElementById(`qr-entrada-${aula.id}`);
          const divSalida = document.getElementById(`qr-salida-${aula.id}`);
          if (divEntrada) renderQR(divEntrada, urlDeSesion(aula.id, 'entrada'));
          if (divSalida) renderQR(divSalida, urlDeSesion(aula.id, 'salida'));
        });
      }, 100);
    }

    function eliminarAula(aulaId) {
      const aula = aulas[aulaId];
      if (!confirm(`¬øEliminar el aula "${aula?.nombre||aulaId}"?`)) return;
      database.ref('aulas/' + aulaId).remove();
      mostrarMensaje('Aula eliminada', 'success');
    }

    window.abrirModalAlumnos = abrirModalAlumnos;
    window.eliminarAlumno = eliminarAlumno;
    window.copiarURL = copiarURL;
    window.exportarExcel = exportarExcel;
    window.eliminarAula = eliminarAula;

    function inicializarEventListeners() {
      $('btnLogin').addEventListener('click', async () => {
        const email = $('email').value.trim();
        const pass  = $('pass').value.trim();
        if (!email || !pass) { mostrarMensaje('Completa correo y contrase√±a', 'error'); return; }
        try {
          await auth.signInWithEmailAndPassword(email, pass);
          mostrarMensaje('Inicio de sesi√≥n exitoso', 'success');
        } catch (e) {
          console.error(e);
          mostrarMensaje('Error al iniciar sesi√≥n: ' + (e.message || e), 'error');
        }
      });

      $('btnSalir').addEventListener('click', async () => {
        await auth.signOut();
        mostrarMensaje('Sesi√≥n cerrada', 'success');
      });

      $('btnNuevaAula').addEventListener('click', () => {
        crearAula();
      });

      $('btnCerrarModal').addEventListener('click', cerrarModal);

      $('nuevoNumControl').addEventListener('input', function(e) {
        this.value = this.value.replace(/\D/g, '').substring(0, 8);
      });
      
      $('nuevoNombre').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]/g, '');
      });

      $('btnAgregarAlumno').addEventListener('click', agregarAlumnoManual);
      $('buscarAlumno').addEventListener('input', renderizarAlumnos);
    }

    database.ref('aulas').on('value', (s) => { aulas = s.val() || {}; renderizarAulas(); });
    database.ref('alumnos').on('value', (s) => {
      alumnosRegistrados = s.val() || {};
      if (aulaSeleccionada) renderizarAlumnos();
      renderizarAulas();
    });
    database.ref('asistencias').on('value', (s) => { asistencias = s.val() || {}; renderizarAulas(); });
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarEventListeners);
    } else {
      inicializarEventListeners();
    }
  </script>
</body>
</html>


